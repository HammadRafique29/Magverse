<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Magverse</title>
    <link rel="stylesheet" href="styles/index.css">
    <link rel="stylesheet" href="styles/generate_audio.css">
</head>
<body>
    <header>
        <div class="navbar">
            <h1>Magverse<span class="tagline">. Generate Animated Story With AI</span></h1>
        </div>
    </header>

    <div id="upload_audio">
        <p>Select Speaker Voice</p>
        <div>
            <p style="font-size: 2vh;">Select Speaker: </p>
            <input type="file" name="" id="speaker_file_picker" placeholder="" accept="audio/*">
        </div>
        <div>
            <button onclick="close_upload_popup()" class="page_control_" id="back_" style="background-color: transparent;width: auto;  color: #666060;">
                Cancel
            </button>
            <button onclick="upload_audio()" class="page_control_" style="text-align: center; background-color: rgb(90 43 141);color: white;" id="upload_and_generate">
                Generate Audio
                <div class="loader" id="loading_animation">
                </div>
            </button>
        </div>
    </div>

    <div class="blur-bg"></div>

    <div class="content-wrapper">
        <div class="content">
            <div id="message">
                <p>We're generated Audios for you</p>
            </div>
    
            <div id="progress_container">
                <div id="audio_progress">
                </div>
            </div>
    
            <p id="generation_output">
                Preparing Video...
            </p>
    
            <div class="button-container">
                <button onclick="history.back()" class="page_control_" id="back_">
                    Back
                </button>
    
                <button onclick="open_upload_popup()" class="page_control_" style="background-color: rgb(90 43 141);" id="next_" class="flex-center">
                    <p id="generate_text">Generate Audio</p>
    
                    <div class="loader" id="loading_animation">
                    </div>
                </button>
            </div>
    
        </div>
    </div>
    
    <script type="module" src="scripts/index.js"></script>

    <script type="module">
        import { transcribe_scene } from './scripts/audio.js';

        const audio_input = document.getElementById("speaker_file_picker");
        const upload_popup = document.getElementById("upload_audio");
        const loader = document.getElementById("loading_animation");
        const generateText = document.getElementById("generate_text");
        let is_audios_genereted = false;

        let story_data = JSON.parse(localStorage.getItem('story_data'));
        console.log(story_data);

        function open_upload_popup() {
            if (is_audios_genereted) go_next();
            else {
                upload_popup.style.display = "block";
                document.querySelector('.content').classList.add('blurred');
            }
        }

        function close_upload_popup() {
            upload_popup.style.display = "none";
            document.querySelector('.content').classList.remove('blurred');
            document.getElementById('popup').style.display = 'none';
        }

        function isValidAudioFile(file) {
            if (!file) {
                console.log("Not filfe")
                return false;
            }
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/ogg'];
            console.log(file.type);
            return allowedTypes.includes(file.type);
        }

        function upload_audio() {

            loader.style.display = "block";
            generateText.style.display = "none";
            const file = audio_input.files[0];

            if (isValidAudioFile(file)) {
                if (upload_popup) upload_popup.style.display = "none";
                is_audios_genereted = true;
                document.querySelector('.content').classList.remove('blurred');
            } else {
                alert("Please Select Speaker File Path First (Audio)...")
            }
            loader.style.display = "none";
            generateText.style.display = "flex";
            
        }

        function transcribe_audios() {
            story_data.scenes.forEach((scene, index) => {
                const { scene_id: sceneId, scene: sceneText, imagePrompt } = scene;
                const audioFilePath = `audio/${sceneId}.wav`;
                transcribe_scene(audioFilePath, sceneText, index);
            });
        }
        function go_next() {
            window.location.href = 'image_render.html';
        }
    </script>
</body>

</html>